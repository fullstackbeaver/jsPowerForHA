import{SerialPort as t,ReadlineParser as e}from"serialport";import o from"ws";const s={"cover.chambre_leo_volet_roulant":{dmxActive:31,dmxDirection:30,id:"chambre_leo_volet_roulant",mqttRetains:!1,mqttTopics:["homeassistant/cover/volet_roulant_chambre_leo/state","homeassistant/cover/volet_roulant_chambre_leo/set-position","homeassistant/cover/volet_roulant_chambre_leo/command"],output:"dmx",protocol:"mqtt"},"cover.chambre_tom_volet_roulant":{dmxActive:33,dmxDirection:32,id:"chambre_tom_volet_roulant",mqttRetains:!1,mqttTopics:["homeassistant/cover/volet_roulant_chambre_tom/state","homeassistant/cover/volet_roulant_chambre_tom/set-position","homeassistant/cover/volet_roulant_chambre_tom/command"],output:"dmx",protocol:"mqtt"},"cover.cuisine_volet_roulant_baie_vitree":{dmxActive:29,dmxDirection:28,id:"cuisine_volet_roulant_baie_vitree",mqttRetains:!1,mqttTopics:["homeassistant/cover/volet_roulant_cuisine_baie_vitree/state","homeassistant/cover/volet_roulant_cuisine_baie_vitree/set-position","homeassistant/cover/volet_roulant_cuisine_baie_vitree/command"],output:"dmx",protocol:"mqtt"},"cover.etage_volet_roulant":{dmxActive:23,dmxDirection:22,id:"etage_volet_roulant",mqttRetains:!1,mqttTopics:["homeassistant/cover/volet_roulant_etage/state","homeassistant/cover/volet_roulant_etage/set-position","homeassistant/cover/volet_roulant_etage/command"],output:"dmx",protocol:"mqtt"},"cover.salon_volet_roulant_fenetre":{dmxActive:27,dmxDirection:26,id:"salon_volet_roulant_fenetre",mqttRetains:!1,mqttTopics:["homeassistant/cover/volet_roulant_salon_fenetre/state","homeassistant/cover/volet_roulant_salon_fenetre/set-position","homeassistant/cover/volet_roulant_salon_fenetre/command"],output:"dmx",protocol:"mqtt"},"cover.salon_volet_roulant_porte_fenetre":{dmxActive:25,dmxDirection:24,id:"salon_volet_roulant_porte_fenetre",mqttRetains:!1,mqttTopics:["homeassistant/cover/volet_roulant_salon_porte_fenetre/state","homeassistant/cover/volet_roulant_salon_porte_fenetre/set-position","homeassistant/cover/volet_roulant_salon_porte_fenetre/command"],output:"dmx",protocol:"mqtt"},"light.chambre_leo_spots":{dmxAddress:16,output:"dmx",protocol:"WS"},"light.chambre_leo_suspension":{dmxAddress:17,output:"dmx",protocol:"WS"},"light.chambre_parents_ruban_led_douche":{dmxAddress:15,output:"dmx",protocol:"WS"},"light.chambre_parents_spots_bureau":{dmxAddress:11,output:"dmx",protocol:"WS"},"light.chambre_parents_spots_penderie":{dmxAddress:13,output:"dmx",protocol:"WS"},"light.chambre_parents_spots_sdb":{dmxAddress:12,output:"dmx",protocol:"WS"},"light.chambre_parents_suspension":{dmxAddress:14,max:50,output:"dmx",protocol:"WS"},"light.chambre_rose_spots":{dmxAddress:9,output:"dmx",protocol:"WS"},"light.chambre_rose_suspension":{dmxAddress:10,output:"dmx",protocol:"WS"},"light.chambre_tom_spots":{dmxAddress:1,output:"dmx",protocol:"WS"},"light.chambre_tom_suspension":{dmxAddress:2,output:"dmx",protocol:"WS"},"light.cuisine_spots_meurtriere":{dmxAddress:21,output:"dmx",protocol:"WS"},"light.cuisine_spots_plan_de_travail":{dmxAddress:19,output:"dmx",protocol:"WS"},"light.cuisine_suspension":{dmxAddress:20,output:"dmx",protocol:"WS"},"light.hall_spots":{dmxAddress:18,max:70,output:"dmx",protocol:"WS"},"light.salle_de_bain_enfants_spots_baignoire_et_wc":{dmxAddress:3,output:"dmx",protocol:"WS"},"light.salle_de_bain_enfants_spots_lavabo":{dmxAddress:4,output:"dmx",protocol:"WS"},"light.salon_spots_bureau":{dmxAddress:7,output:"dmx",protocol:"WS"},"light.salon_spots_canape_cheminee":{dmxAddress:8,output:"dmx",protocol:"WS"},"light.salon_spots_fenetre":{dmxAddress:5,output:"dmx",protocol:"WS"},"light.salon_suspension":{dmxAddress:6,output:"dmx",protocol:"WS"},"switch.cellier_relais_exterieur":{dmxAddress:42,output:"dmx",protocol:"WS"},"switch.cellier_relais_puissance_eclairage":{dmxAddress:37,output:"dmx",protocol:"WS"},"switch.cellier_relais_telerupteur_1":{dmxAddress:38,output:"dmx",protocol:"WS"},"switch.cellier_relais_telerupteur_2":{dmxAddress:39,output:"dmx",protocol:"WS"},"switch.cellier_relais_telerupteur_3":{dmxAddress:40,output:"dmx",protocol:"WS"},"switch.cellier_relais_telerupteur_4":{dmxAddress:41,output:"dmx",protocol:"WS"},"switch.etage_suspension_bureau":{dmxAddress:33,output:"dmx",protocol:"WS"},"switch.etage_suspension_zone_1":{dmxAddress:35,output:"dmx",protocol:"WS"},"switch.etage_suspension_zone_2":{dmxAddress:34,output:"dmx",protocol:"WS"},"switch.salle_de_bain_etage_suspension":{dmxAddress:36,output:"dmx",protocol:"WS"}},r=s,n=(i="WS",Object.keys(s).filter((t=>s[t].protocol===i)));var i;function a(t,e){r[t].value=e}const l=750,c=10;let d;function u(t){console.log("writeToDMX",t),d&&d.write(Buffer.from(t))}const _=new Array(function(){const t=[0];for(const e of Object.values(r))e.dmxActive&&t.push(e.dmxActive),e.dmxAddress&&t.push(e.dmxAddress),e.dmxDirection&&t.push(e.dmxDirection);return Math.max(...t)+1}()).fill(0),m={};let p;function x(){for(const[t,e]of Object.entries(m))e.currentValue+=e.gap,h(t,e.dmxAddress,e.currentValue),e.step--,0===e.step&&delete m[t];u(_),0===Object.keys(m).length&&(clearInterval(p),p=void 0)}function h(t,e,o){a(t,o),_[e]=Math.round(o)}var v,b,f;let A;v="/dev/ttyACM0",console.log(v),d=new t({autoOpen:!1,baudRate:25e4,path:v},(t=>{t&&(console.error("Error on DMX port creation: ",t),process.exit())})),d.open(),d.on("error",(t=>{console.error("Error on DMX port: ",t),process.exit()})),d.pipe(new e({delimiter:"\r\n"})).on("data",console.log),function(t){t.event="event",t.result="result"}(b||(b={})),function(t){t.auth="auth",t.callService="call_service",t.getStates="get_states",t.subscribeEvents="subscribe_events"}(f||(f={}));let g=0;function S(t,e){g++;const o={id:g,type:t};e&&Object.assign(o,e),console.log("sendMessage",o,JSON.stringify(o)),A.send(JSON.stringify(o))}var W,w;W=function(t){if(Array.isArray(t))for(const e of t)n.includes(e.entity_id)&&a(e.entity_id,e?.attributes?.brightness??0)},w=function({attributes:t,entity_id:e,state:o}){if(n.includes(e)){const s=r[e];e.startsWith("light")&&s.dmxAddress&&function(t,e,o,s){o=o??0,m[t]&&(o=Math.round(m[t].currentValue)),m[t]={currentValue:o,dmxAddress:e,gap:(s-o)/c,step:c},p||(p=setInterval(x,l/1e3))}(e,s.dmxAddress,s.value,function(t,e,o){return"off"===t?0:(null===e&&(e=255),o&&(e=Math.round(o*e/255)),e)}(o,t.brightness,s.max)),e.startsWith("switch")&&s.dmxAddress&&function(t,e,o){h(t,e,o),u(_)}(e,s.dmxAddress,function(t){return"off"===t?0:255}(o))}},A=new o("ws://192.168.1.4:8123/api/websocket"),A.on("open",(function(){console.log("Connected to Home Assistant WebSocket")})),A.on("message",(function(t){const e=JSON.parse(t.toString("utf8"));switch(e.id>g&&(g=e.id),e.type){case"auth_ok":S(f.getStates),S(f.subscribeEvents,{event_type:"state_changed"});break;case"auth_invalid":console.error("Authentication failed");break;case"auth_required":A.send(JSON.stringify({type:f.auth,access_token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI3ZDA4MWExMjYzNzY0MmM0OTIxYjZiNDU3MDA1OGMzMyIsImlhdCI6MTcyMDAxMjQwNSwiZXhwIjoyMDM1MzcyNDA1fQ.flz9XoB95_Ef7lwltvuwy3zmbOLHee64SE51Uk_vr8k"}));break;case b.result:W(e.result);break;case b.event:w(e.event.data.new_state)}})),A.on("error",(function(t){console.error("WebSocket error:",t)})),A.on("close",(function(){console.warn("Disconnected from Home Assistant WebSocket")}));
